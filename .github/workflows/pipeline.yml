name: lint â†’ test â†’ measure â†’ db â†’ sast â†’ integration

on:
  pull_request:
    branches:
      - main
      - master

jobs:
  lint:
    name: ğŸ” Lint
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Source Code
        uses: actions/checkout@v4

      - name: ğŸ›  Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Download Node modules
        run: npm ci

      - name: âœ… Run ESLint
        run: npm run lint

      - name: ğŸ¨ Check Prettier formatting
        run: npx prettier --check "src/**/*.js" "tests/**/*.js" "*.json"

  test:
    name: âœ… Unit Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Source Code
        uses: actions/checkout@v4

      - name: ğŸ›  Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Download Node modules
        run: npm ci

      - name: ğŸ§ª Run Unit Tests with Coverage
        run: npm run test:unit

      - name: â¬†ï¸ Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/

  measure:
    name: ğŸ“Š Coverage / Measuring Unit
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Source Code
        uses: actions/checkout@v4

      - name: ğŸ›  Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Download Node modules
        run: npm ci

      - name: â¬‡ï¸ Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage
          path: coverage/

      - name: ğŸ“Š Enforce Coverage Threshold (80%)
        run: |
          npm run test:coverage
          COVERAGE=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âŒ Coverage too low! Required: 80%, Actual: $COVERAGE%"
            exit 1
          else
            echo "âœ… Coverage meets threshold: $COVERAGE%"
          fi

  db:
    name: ğŸ—„ Database Migration
    needs: measure
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Source Code
        uses: actions/checkout@v4

      - name: ğŸ›  Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Download Node modules
        run: npm ci

      - name: ğŸ—„ Run Database Migration Script
        run: npm run db:migrate

  sast:
    name: ğŸ›¡ SAST Security Scan
    needs: db
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Source Code
        uses: actions/checkout@v4

      - name: ğŸ›  Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Download Node modules
        run: npm ci

      - name: ğŸ” Static Application Security Testing
        run: npm run sast

      - name: ğŸ”’ NPM Security Audit
        run: npm audit --audit-level moderate

  integration:
    name: ğŸ”— Integration Tests
    needs: sast
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Source Code
        uses: actions/checkout@v4

      - name: ğŸ›  Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Download Node modules
        run: npm ci

      - name: ğŸ§ª Run Integration Tests
        run: npm run test:integration
